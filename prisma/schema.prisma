datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

model Artwork {
  id          String   @id @default(cuid())
  title       String
  artist      String
  description String
  price       Int
  imageUrl    String   @default("")
  category    String   @default("målning")
  year        Int
  status      String   @default("tillgänglig")
  views       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ─── Freemium Usage ─────────────────────────────────────────

model DailyUsage {
  id               String   @id @default(cuid())
  anonId           String
  date             String   // YYYY-MM-DD
  generationsUsed  Int      @default(0)
  refinesUsed      Int      @default(0)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([anonId, date])
  @@index([anonId])
  @@index([date])
}

// ─── Poster Lab ─────────────────────────────────────────────

model CreditAccount {
  id             String   @id @default(cuid())
  userId         String   @unique
  balance        Int      @default(0)
  totalPurchased Int      @default(0)
  totalSpent     Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model CreditTransaction {
  id          String   @id @default(cuid())
  userId      String
  amount      Int
  type        String   // 'purchase' | 'spend' | 'refund'
  description String   @default("")
  orderId     String?
  createdAt   DateTime @default(now())

  @@index([userId])
}

model Design {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String   @default("")
  imageUrl    String
  mockupUrl   String   @default("")

  // Core metadata for gallery + "Create similar"
  roomType    String?  // e.g. "livingroom", "kidsroom"
  style       String
  colorMood   String?  // e.g. "warm", "cool", "dark"
  prompt      String   @default("")

  // Editor state (persistence for "säljläge")
  selectedVariantId String?  // which variant the user picked
  roomImageUrl      String?  // room photo URL
  wallCorners       String?  // JSON array of {x,y}
  positionX         Float    @default(0.5)
  positionY         Float    @default(0.4)
  scale             Float    @default(1.0)
  frameId           String   @default("none")
  sizeId            String   @default("50x70")
  cropMode          CropMode @default(COVER)
  cropOffsetX       Float    @default(0)  // -1 to 1, 0 = centered
  cropOffsetY       Float    @default(0)  // -1 to 1, 0 = centered

  isPublic    Boolean  @default(false)
  likesCount  Int      @default(0)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  likes       Like[]
  roomMeta    RoomMeta?
  orderItems  OrderItem[]
  assets      DesignAsset[]
  variants    DesignVariant[]

  @@index([userId])
  @@index([style])
  @@index([isPublic, createdAt])
}

model DesignVariant {
  id           String   @id @default(cuid())
  designId     String
  imageUrl     String   // Vercel Blob persistent URL
  thumbnailUrl String   @default("")
  seed         Int      @default(0)
  sortOrder    Int      @default(0)
  createdAt    DateTime @default(now())

  design       Design   @relation(fields: [designId], references: [id], onDelete: Cascade)

  @@index([designId])
}

model Like {
  id        String   @id @default(cuid())
  designId  String
  anonId    String   // from cookie/session (no login required)
  createdAt DateTime @default(now())

  // Relations
  design    Design   @relation(fields: [designId], references: [id], onDelete: Cascade)

  @@unique([designId, anonId])
  @@index([designId])
  @@index([anonId])
}

model RoomMeta {
  id        String   @id @default(cuid())
  designId  String   @unique

  wallColor String?
  lightType String?  // e.g. "north", "warm-lamp", "mixed"
  vibe      String?  // e.g. "cozy", "minimal", "playful"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  design    Design   @relation(fields: [designId], references: [id], onDelete: Cascade)

  @@index([designId])
}

// ─── Enums ──────────────────────────────────────────────────

enum CropMode {
  COVER
  CONTAIN
  FILL
}

enum OrderStatus {
  DRAFT
  AWAITING_PAYMENT
  PAID
  IN_PRODUCTION
  SHIPPED
  DELIVERED
  CANCELED
  REFUNDED
}

enum FulfillmentStatus {
  NOT_STARTED
  QUEUED
  SENT_TO_PARTNER
  IN_PRODUCTION
  SHIPPED
  DELIVERED
  CANCELED
  FAILED
}

enum PaymentProvider {
  STRIPE
  MANUAL
}

enum AssetRole {
  PREVIEW
  PRINT
  PRINT_FINAL
  THUMB
}

enum PrintProductType {
  POSTER
  CANVAS
  METAL
  FRAMED_POSTER
}

enum FrameColor {
  NONE
  BLACK
  WHITE
  OAK
  WALNUT
}

enum PaperType {
  DEFAULT
  MATTE
  SEMI_GLOSS
  FINE_ART
}

// ─── Order System ───────────────────────────────────────────

model Order {
  id            String      @id @default(cuid())

  anonId        String?

  status        OrderStatus @default(DRAFT)

  currency      String      @default("SEK")
  subtotalCents Int         @default(0)
  shippingCents Int         @default(0)
  taxCents      Int         @default(0)
  totalCents    Int         @default(0)

  payment       Payment?
  shippingAddress ShippingAddress?
  items         OrderItem[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([anonId])
  @@index([status])
  @@index([createdAt])
}

model OrderItem {
  id            String   @id @default(cuid())
  orderId       String
  designId      String

  productType   PrintProductType
  sizeCode      String
  paperType     PaperType @default(DEFAULT)

  frameColor    FrameColor @default(NONE)
  frameWidthMm  Int?
  matEnabled    Boolean   @default(false)

  quantity      Int      @default(1)

  unitPriceCents Int
  lineTotalCents Int

  fulfillment   Fulfillment?

  order         Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  design        Design   @relation(fields: [designId], references: [id], onDelete: Restrict)

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([orderId])
  @@index([designId])
}

model Payment {
  id            String         @id @default(cuid())
  orderId       String         @unique
  provider      PaymentProvider @default(STRIPE)

  stripeCheckoutSessionId String?
  stripePaymentIntentId   String?

  amountCents   Int
  currency      String      @default("SEK")

  paidAt        DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  order         Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([stripeCheckoutSessionId])
  @@index([stripePaymentIntentId])
}

model ShippingAddress {
  id          String @id @default(cuid())
  orderId     String @unique

  fullName    String
  email       String
  phone       String?

  address1    String
  address2    String?
  postalCode  String
  city        String
  region      String?
  countryCode String @default("SE")

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  order       Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([email])
}

model Fulfillment {
  id            String            @id @default(cuid())
  orderItemId   String            @unique

  status        FulfillmentStatus @default(NOT_STARTED)

  partnerId     String?
  partnerOrderRef String?

  carrier       String?
  trackingNumber String?
  trackingUrl   String?

  internalNote  String?

  sentToPartnerAt DateTime?
  shippedAt     DateTime?
  deliveredAt   DateTime?

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  orderItem     OrderItem @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  partner       PrintPartner? @relation(fields: [partnerId], references: [id], onDelete: SetNull)

  @@index([status])
  @@index([partnerOrderRef])
}

model PrintPartner {
  id          String @id @default(cuid())
  name        String
  countryCode String?
  isActive    Boolean @default(true)

  apiBaseUrl  String?
  apiKeyHint  String?

  contactEmail String?
  contactPhone String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  fulfillments Fulfillment[]
}

// ─── Art Market ─────────────────────────────────────────────

model ArtistProfile {
  id            String   @id @default(cuid())
  email         String   @unique
  displayName   String
  bio           String   @default("")
  avatarUrl     String   @default("")
  website       String   @default("")
  instagram     String   @default("")
  phone         String   @default("")

  // Payout
  bankAccount   String   @default("")  // For payouts
  orgNumber     String   @default("")  // Org/personnummer

  // Terms
  acceptedTermsAt DateTime?  // When they accepted 50/50 split terms
  isApproved      Boolean  @default(false)  // Admin approval
  isActive        Boolean  @default(true)

  // Auth — simple token-based for now
  accessToken     String   @unique @default(cuid())

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  listings      ArtworkListing[]
  marketOrders  MarketOrder[]

  @@index([email])
  @@index([accessToken])
}

model ArtworkListing {
  id            String   @id @default(cuid())
  artistId      String

  title         String
  description   String   @default("")
  technique     String   @default("")  // e.g. "Olja på duk", "Fotografi", "Akvarell"
  category      String   @default("painting")  // painting, photo, print, digital, mixed
  year          Int?

  // Image
  imageUrl      String   // Original high-res uploaded to Blob
  thumbnailUrl  String   @default("")

  // Original dimensions (if physical artwork)
  widthCm       Float?
  heightCm      Float?

  // Pricing — artist sets base price, Artboris adds frame/print cost
  artistPriceSEK  Int    // What the artist wants (before 50/50 split)
  isOriginal      Boolean @default(false)  // true = one-of-a-kind, false = print/reproduction

  // Availability
  isPublished     Boolean @default(false)
  isSold          Boolean @default(false)  // For originals
  maxPrints       Int?    // null = unlimited prints
  printsSold      Int     @default(0)

  // Stats
  views           Int     @default(0)
  tryOnWallCount  Int     @default(0)  // How many times someone tried it on their wall

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  artist        ArtistProfile @relation(fields: [artistId], references: [id], onDelete: Cascade)
  marketOrders  MarketOrder[]

  @@index([artistId])
  @@index([isPublished, createdAt])
  @@index([category])
}

enum MarketOrderStatus {
  PENDING
  PAID
  IN_PRODUCTION
  SHIPPED
  DELIVERED
  CANCELED
}

model MarketOrder {
  id              String   @id @default(cuid())
  listingId       String
  artistId        String
  buyerAnonId     String?

  // Product details
  sizeCode        String   // e.g. "50x70"
  frameColor      FrameColor @default(NONE)
  paperType       PaperType  @default(DEFAULT)

  // Pricing breakdown (all in SEK öre / cents)
  artistShareCents  Int    // 50% of artwork price
  platformShareCents Int   // 50% of artwork price
  frameCostCents    Int    @default(0)  // Frame + print cost (Artboris keeps 100%)
  shippingCents     Int    @default(0)
  totalCents        Int    // Grand total charged to buyer

  // Payment
  stripePaymentIntentId String?
  paidAt              DateTime?

  // Fulfillment
  status            MarketOrderStatus @default(PENDING)
  trackingNumber    String?
  trackingUrl       String?

  // Buyer info
  buyerName         String   @default("")
  buyerEmail        String   @default("")
  buyerAddress      String   @default("")
  buyerPostalCode   String   @default("")
  buyerCity         String   @default("")
  buyerCountry      String   @default("SE")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  listing         ArtworkListing @relation(fields: [listingId], references: [id], onDelete: Restrict)
  artist          ArtistProfile  @relation(fields: [artistId], references: [id], onDelete: Restrict)

  @@index([listingId])
  @@index([artistId])
  @@index([status])
  @@index([buyerAnonId])
}

// ─── Print Assets ───────────────────────────────────────────

model DesignAsset {
  id         String    @id @default(cuid())
  designId   String
  role       AssetRole

  url        String
  widthPx    Int?
  heightPx   Int?
  dpi        Int?
  fileSize   Int?
  mimeType   String?

  // Upscale metadata
  sourceWidthPx    Int?
  sourceHeightPx   Int?
  upscaleFactor    Int?
  upscaleProvider  String?  // e.g. "replicate"

  sizeCode   String?
  productType PrintProductType?

  createdAt  DateTime  @default(now())

  design     Design    @relation(fields: [designId], references: [id], onDelete: Cascade)

  @@index([designId])
  @@index([role])
  @@unique([designId, role, sizeCode, productType])
}
